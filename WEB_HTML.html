<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
	<link rel="stylesheet" href="WEB_CSS.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  	<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.2"></script>
 	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@0.7.7"></script>
  	<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/1.2.1/exceljs.min.js" integrity="sha512-eKWlYEv9gY7bqXRR9UCmGZYqLO9znN0W84EtpRo2h6jxGHxJ/v0oXofDTLqMzV44KVmM964usJGqVox/tpfKSA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
		<div class="khoi1">
			
			<!-- khoi 1 -->
			<div class="thongtin">
				<!-- <img class="anh1" src="http://dut.udn.vn/Files/admin/images/Tin_tuc/Khac/2020/LogoDUT/image002.jpg"> -->
				<img class="anh1" src="khoa.jfif">
				<div class="logo">

					
					<div class="logo_giua">
				
						<h2>ĐẠI HỌC BÁCH KHOA</h2>
						<h2>ĐẠI HỌC ĐÀ NẴNG</h2>
						<h2>KHOA ĐIỆN </h2>
					</div>
					<h1>ĐỒ ÁN TỐT NGHIỆP</h1>
					<h2></h2>

				</div>	
				<img class="anh2" src="shinko.jpg">	
										
			</div>	
			<div class="logo_duoi">
					<h3>GVHD: TS. NGÔ ĐÌNH THANH</h3>
					
					
				</div>	
				<h3 class="duoi_1">CBHD: NGUYỄN CHÍ THẮNG </h3>
		</div>

<!-------------- hoạt động chung --------------->

	<div class="khoi2">

	<!-- khoi ket nối -->
<!-- 		<div class="ketnoi">
		<div class="tieude"><h3>Vui lòng kết nối Internet</h3></div>
			<iframe src="https://www.google.com/" width="100%" height="500px" name="the-iframe" frameborder="0"></iframe>
			<p>IP:<span id="IPconnect"> </span></p>

		</div> -->

	<!-- khối điều khiển -->
		<div class="dieukhien">


			<div class="tieude">
				<h3>THÔNG SỐ THỰC TẾ </h3>
				<!-- <h3>ĐIỀU KHIỂN TRÊN ROBOT</h3> -->
			</div>

            <div class = "chedo">
            	<p>GIÁ TRỊ HIỆN TẠI </p>
                <div  id ="PV1">
				<h3> PV : <span id="giatriPV">00</span>&#8451;</h3>
			
                  <!--  <div class = "inner-circle"></div>  --> 
                </div>
				
            </div>
            
			<div class="tieude">
				
				<!-- <h3>ĐIỀU KHIỂN TRÊN ROBOT</h3> -->
			</div>

            <div class = "chedo">
            	<p>GIÁ TRỊ ĐÃ CÀI ĐẶT </p>
                <div  id ="SV1">
				<h3> SV : <span id="giatriSV">00</span>&#8451;</h3>
			
                  <!--  <div class = "inner-circle"></div>  --> 
                </div>
				
            </div>

			<div class="tieude">
				<h3>THÔNG SỐ CÀI ĐẶT </h3>
			</div>

			<div class = "chedo">
            	<p>GIÁ TRỊ CÀI ĐẶT </p>
                <div class = "PV" id ="act">
					 <input type="text" name="SV" id="CV1" placeholder="Nhập dữ liệu" >
					<br />
					<div class = "inner-circle"></div>
					
                </div>
				<button id= "send" type="submit" >Submit</button>
            </div>
			
			
            
			<!--<div class="ketnoi">-->
			<div class="tieude">
				<h3>LỊCH SỬ NHIỆT ĐỘ </h3>
			</div>
			
			<div class = "chedo1">
			<!--<p> <span id="currentDateTime"></span></p>-->
			<button id="excel">XUẤT FILE EXCEL</button>
			<span id="currentDateTime"></span>
		
			</div>	
		
			<!-- Vùng hiển thị biểu đồ -->
			
			<div class="btn_" id="myChart">
					<!-- cấu hình chi đó -->
				
			</div>
			
		</div>
			
		


	<!-- khoi hiển thị -->

		
		<div class="hienthi">
		<div class="tieude">
			<h3>BIỂU ĐỒ </h3>
		
		</div>
		<div  class="chartContainer">
		<canvas id="realTimeChart"></canvas>
		
		</div>
		
		</div>	

		<!-- file Js -->
		
	
	
	<script type="module">
		
		
		// Import the functions you need from the SDKs you need
		import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
		import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";
		import {getDatabase, ref, get, set, child, push, remove, onValue}
		from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"
		
		// TODO: Add SDKs for Firebase products that you want to use
		// https://firebase.google.com/docs/web/setup#available-libraries
		
		// Your web app's Firebase configuration
		// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		const firebaseConfig = {
			apiKey: "AIzaSyBkX1ieE1j2bAbY33XiNojMEHzZyJEP5-w",
			authDomain: "bbbcc-22472.firebaseapp.com",
			databaseURL: "https://bbbcc-22472-default-rtdb.firebaseio.com",
			projectId: "bbbcc-22472",
			storageBucket: "bbbcc-22472.appspot.com",
			messagingSenderId: "670082950114",
			appId: "1:670082950114:web:5c5b46f9ec3f39ee884fbb",
			measurementId: "G-M3KYQY0F66"
		};

		// Initialize Firebase
		// Khởi tạo Firebase
		
		const app = initializeApp(firebaseConfig);
		const analytics = getAnalytics(app);
		
		//firebase.initializeApp(firebaseConfig);
		//var database = firebase.database();
		const db = getDatabase();
		
		var enterID = document.querySelector("#CV1");
		var insertBtn = document.querySelector("#send");
		
				function wirteData() {
					set(ref(db, "DATA2/"),{
						
						SV: CV1.value,
						
					})
					.then(()=>{
						alert("Data added successfully");
					})
					.catch((error)=>{
						alert(error);
					});
				}
		
				insertBtn.addEventListener('click', wirteData);
	
				/*
				var valueTemp = firebase.database().ref('DATA').child('CV');
				valueTemp.on('value',snap =>{
				//console.log("nhiet do : " + snap.val());
				document.getElementById("PV1").innerHTML=snap.val()+" C";
				});
				
				
				*/
			// lay du lieu //
				
				const starCountRefPV = ref(db, 'DATA1/PV');
				onValue(starCountRefPV, (snapshot) => {
					const data0 = snapshot.val();
					console.log(">>>>>>>>>>>>",data0);
					document.getElementById('giatriPV').innerHTML = data0;
				});
				
				const starCountRefSV = ref(db, 'DATA1/SV');
				onValue(starCountRefSV, (snapshot) => {
					const data1 = snapshot.val();
					console.log(">>>>>>>>>>>>",data1);
					document.getElementById('giatriSV').innerHTML = data1;
				});
			// hiển thị thời gian 	//
			function updateTime() {
			var currentDate = new Date();
			var year = currentDate.getFullYear();
			var month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
			var day = currentDate.getDate().toString().padStart(2, '0');
			var hour = currentDate.getHours().toString().padStart(2, '0');
			var minute = currentDate.getMinutes().toString().padStart(2, '0');
			var second = currentDate.getSeconds().toString().padStart(2, '0');

			var dateTimeString = hour + ':' + minute + ':' + second + ', ' + day + '/' + month + '/' + year;

			// Cập nhật nội dung trong phần tử có id "currentDateTime"
			document.getElementById('currentDateTime').textContent = dateTimeString;
			}

			// Cập nhật thời gian mỗi giây
			setInterval(updateTime, 1000);	

	// vẽ biểu đồ //
	// Tạo biểu đồ rỗng
	const canvas = document.getElementById('realTimeChart');

    // Khởi tạo biểu đồ với dữ liệu rỗng
    const chart = new Chart(canvas, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Real-time Data',
          data: [],
          borderColor: 'blue',
         // backgroundColor: 'rgba(0, 0, 255, 0.5)',
         // fill: 'start'
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'time',
        
            title: {
              display: true,
			  
              text: 'Time'
            }
          },
          yAxes: [{
            title: {
			
              display: true,
              text: 'nhiệt độ '
            },
			ticks: {
                    beginAtZero:true,
					//suggestedMin: -250 // Giá trị âm nhỏ nhất trên trục y
                }
			
          }]
          
        }
      }
    });
    // lay du lieu //
	let firebaseData = []; // Khởi tạo mảng để lưu dữ liệu từ Firebase		
    const starCountRefP = ref(db, 'DATA1/PV');
			onValue(starCountRefP, (snapshot) => {
			const data = snapshot.val();
			console.log(">>>>>>>>>>>>",data);
         // firebaseData.push(data);
         firebaseData = data;
			});
    
    // Hàm cập nhật biểu đồ với dữ liệu mới
    function updateChart() {
      var time = new Date();
	  time = time.getHours()+":"+ time.getMinutes()+":"+time.getSeconds();
      const data = firebaseData ;

      // Thêm nhãn thời gian và dữ liệu mới vào biểu đồ
      chart.data.labels.push(time);
      chart.data.datasets[0].data.push(data);

      // Giới hạn số lượng điểm trên biểu đồ
      const maxDataPoints = 15;
      if (chart.data.labels.length > maxDataPoints) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
     /* // Cập nhật tỉ lệ khung của trục y
      let max = Math.max(data); // Lấy giá trị lớn nhất trong mảng dữ liệu
      let padding = max * 0.1; // Tính padding cho giá trị lớn nhất
      Chart.options.scales.y.max = max + padding; // Cập nhật giá trị max của trục y
      */
      // Cập nhật biểu đồ
      chart.update();
    }

    // Cập nhật biểu đồ liên tục sau mỗi giây
    setInterval(updateChart, 1000);
			
	
//dữ liệu lên firebase // ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
const dm = getDatabase();
 
 // Hàm lắng nghe sự kiện thay đổi dữ liệu từ Firebase
 onValue(ref(dm, 'DATA1/PV'), (snapshot) => {
   const data = snapshot.val();
   const time = new Date().toLocaleString();
   const newData = {
	 data: data,
	 time: time // Thời gian ghi nhận dữ liệu
   };
   console.log('>>>>>', time);
   pushDataToFirebase(newData);
 });
 
 // Hàm đẩy dữ liệu lên Firebase
 function pushDataToFirebase(data) {
   const dataRef = ref(dm, 'history000/PV');
   push(dataRef, data)
	 .then(() => {
	   console.log('Đẩy dữ liệu thành công');
	 })
	 .catch((error) => {
	   console.error('Lỗi khi đẩy dữ liệu:', error);
	 });
 }
 
 // ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
 
 // Lấy tham chiếu đến nút nhấn
 const button = document.getElementById('excel');
 
 // Gắn sự kiện click cho nút nhấn
 button.addEventListener('click', exportToExcel);
 const database = getDatabase();
 
 async function exportToExcel() {
   let firebaseData1 = []; // Khởi tạo mảng để lưu dữ liệu từ Firebase
   
   const starCountRef = ref(database, 'history000/PV');
   
   const snapshot = await get(starCountRef);
   const data = snapshot.val();
   firebaseData1 = Object.values(data);
   console.log(">>>>>>>>>>>>",firebaseData1);
 /*
  var time = new Date() 
 
	  time = time.getHours()+":"+ time.getMinutes()+":"+time.getSeconds();
		
	   
	  
	   // lưu làm lịch sử 
	   var dataArray = []; // Khởi tạo mảng để lưu trữ thời gian và dữ liệu
		   var entry = {
			   time: time,
			   data: data
		   };
 
		   dataArray.push(entry); // Thêm entry vào mảng dataArray
   */ 
 
   const workbook = new ExcelJS.Workbook();
 
   const worksheet = workbook.addWorksheet('Data');
 /*
  const rows = firebaseData1.map((item) => [new Date(item.time), item.data]);
   console.log(">>>>>>>>>>>>",item.time, item.data);
 
  var rows = firebaseData1.map((item, index) => {
   console.log(`Item at index ${index}:`, item.data);
   return [new Date(item.time), item.data];
 });
 */
 // Chuyển đổi mảng dataArray để phù hợp với việc tải về Excel
 var rows = firebaseData1.map(item => [item.time, item.data]);
   worksheet.addRows(rows);
 
   const buffer = await workbook.xlsx.writeBuffer();
  // console.log(">>>>>>>>>>>>",buffer);
   const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
   const url = URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url;
   a.download = 'data.xlsx';
   a.click();
 
 }			
	</script>
</body>
</html>